<div class="admin-container">
    <div class="notification-toast" *ngIf="notification" [class.success]="notification.type === 'success'"
        [class.error]="notification.type === 'error'">
        <span class="msg">{{ notification.message }}</span>
        <button class="close-btn" (click)="notification = null">✕</button>
    </div>

    <div class="header-section">
        <div class="header-left">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                    class="title-icon">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                Gestion des Entrepôts
            </h1>
            <div class="search-box">
                <div class="search-input-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" [(ngModel)]="searchTerm" (input)="onSearch()" placeholder="Rechercher...">
                </div>
            </div>
        </div>
        <button class="btn-add" (click)="openCreateModal()" *ngIf="canManage()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Nouvel Entrepôt
        </button>
    </div>

    <div class="stats-overview" *ngIf="!loading && entrepots.length > 0">
        <div class="stat-card">
            <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Total Entrepôts</span>
                <span class="stat-value">{{ entrepots.length }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Villes</span>
                <span class="stat-value">{{ getUniqueVilles() }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Capacité (m²)</span>
                <span class="stat-value">{{ getTotalCapacite() | number }}</span>
            </div>
        </div>
    </div>

    <div class="table-container" *ngIf="!loading">
        <table>
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Adresse</th>
                    <th>Ville</th>
                    <th>Taille</th>
                    <th *ngIf="canManage()">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let entrepot of filteredEntrepots">
                    <td>
                        <span class="item-name">{{ entrepot.nomEntrepot }}</span>
                    </td>
                    <td>{{ entrepot.adresse }}</td>
                    <td>{{ entrepot.ville }}</td>
                    <td>
                        <span class="size-badge">{{ entrepot.taille || 0 }} m²</span>
                    </td>
                    <td *ngIf="canManage()">
                        <div class="actions">
                            <button class="btn-icon btn-edit" title="Modifier" (click)="openEditModal(entrepot)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-icon btn-delete" title="Supprimer" (click)="confirmDelete(entrepot)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="empty-state" *ngIf="filteredEntrepots.length === 0 && !loading">
        <p>Aucun entrepôt trouvé.</p>
    </div>
</div>

<!-- Add/Edit Warehouse Modal (Styled like Add Piece) -->
<div class="modal-overlay entrepot-modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content entrepot-modal-content" (click)="$event.stopPropagation()">
        <div class="entrepot-modal-header">
            <div class="entrepot-modal-title-block">
                <div class="entrepot-modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                        </path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                </div>
                <div>
                    <h2>{{ selectedEntrepot ? 'Modifier' : 'Ajouter' }} un Entrepôt</h2>
                    <p class="entrepot-modal-subtitle">Gestion technique et logistique des capacités de stockage</p>
                </div>
            </div>
            <button class="btn-icon entrepot-modal-close" (click)="closeCreateModal()" type="button" title="Fermer">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <form (ngSubmit)="saveEntrepot()" class="entrepot-modal-form">
            <div class="entrepot-form-scroll">
                <div class="entrepot-form-group">
                    <label>Nom de l'entrepôt*</label>
                    <input type="text" [(ngModel)]="newEntrepot.nomEntrepot" name="nomEntrepot" required
                        placeholder="Ex: Hub Distribution Nord">
                </div>
                <div class="entrepot-form-group">
                    <label>Adresse détaillée*</label>
                    <input type="text" [(ngModel)]="newEntrepot.adresse" name="adresse" required
                        placeholder="Numéro et nom de rue">
                </div>
                <div class="entrepot-form-group">
                    <label>Ville*</label>
                    <input type="text" [(ngModel)]="newEntrepot.ville" name="ville" required
                        placeholder="Localisation principale">
                </div>
                <div class="entrepot-form-group">
                    <label>Capacité (m²)*</label>
                    <input type="number" [(ngModel)]="newEntrepot.taille" name="taille" required min="0"
                        placeholder="Surface totale exploitable">
                </div>
            </div>

            <div class="entrepot-modal-actions">
                <button type="button" class="btn-secondary" (click)="closeCreateModal()">Annuler</button>
                <button type="submit" class="btn-primary entrepot-btn-save"
                    [disabled]="!newEntrepot.nomEntrepot || !newEntrepot.adresse || !newEntrepot.ville || newEntrepot.taille === null">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    {{ selectedEntrepot ? 'Mettre à jour' : 'Enregistrer' }}
                </button>
            </div>
        </form>
    </div>
</div>


<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="cancelDelete()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
        <div class="warning-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 0 0 0 1.71 3h16.94a2 0 0 0 1.71-3L13.71 3.86a2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        </div>
        <h3>Confirmer la suppression</h3>
        <p>Voulez-vous vraiment supprimer l'entrepôt <strong>{{ itemToDelete?.nomEntrepot }}</strong> ?</p>
        <p class="sub-text">Cette action est irréversible.</p>
        <div class="modal-actions">
            <button class="btn-secondary" (click)="cancelDelete()">Annuler</button>
            <button class="btn-danger" (click)="deleteEntrepot()">Supprimer</button>
        </div>
    </div>
</div>