<div class="admin-container">
    <div class="notification-toast" *ngIf="notification" [class.success]="notification.type === 'success'"
        [class.error]="notification.type === 'error'">
        <span class="msg">{{ notification.message }}</span>
        <button class="close-btn" (click)="notification = null">✕</button>
    </div>

    <div class="header-section">
        <div class="header-left">
            <h1>
                <div class="title-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                </div>
                Gestion des Produits Finis
            </h1>
            <div class="search-box">
                <div class="search-input-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" [(ngModel)]="searchTerm" placeholder="Rechercher un produit...">
                </div>
                <select class="category-select" [(ngModel)]="searchCategory">
                    <option value="all">Tout</option>
                    <option value="code">Code Produit</option>
                    <option value="designation">Désignation</option>
                    <option value="piece">Pièce Associée</option>
                </select>
            </div>
        </div>
        <button class="btn-add" (click)="openCreateModal()" *ngIf="canManage()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Nouveau Produit
        </button>
    </div>

    <div class="card-grid">
        <div class="item-card" *ngFor="let produit of filteredProduits">
            <div class="card-image">
                <img [src]="getImageUrl(produit.imageUrl)"
                    onerror="this.onerror=null;this.src='assets/images/default-produit.svg'">
                <div class="card-actions-overlay" *ngIf="canManage()">
                    <button class="action-btn edit" title="Modifier" (click)="openEditModal(produit)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn delete" [class.not-deletable]="(produit.pieces?.length || 0) > 0"
                        [title]="(produit.pieces?.length || 0) > 0 ? 'Impossible de supprimer : ce produit est associé à ' + produit.pieces?.length + ' pièces' : 'Supprimer'"
                        (click)="(produit.pieces?.length || 0) === 0 ? confirmDelete(produit) : $event.stopPropagation()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="card-content">
                <div class="card-header-info">
                    <h3 class="item-title">{{ produit.designation }}</h3>
                    <code class="item-code">{{ produit.code }}</code>
                </div>
                <div class="item-details">
                 
                </div>
                <button class="btn-view-associated" *ngIf="produit.pieces && produit.pieces.length > 0"
                    (click)="showAssociatedPieces(produit)" title="Voir les pièces associées">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                        </path>
                    </svg>
                    {{ produit.pieces.length }} pièce{{ produit.pieces.length > 1 ? 's' : '' }}
                </button>
            </div>
        </div>
    </div>

    <div class="empty-state" *ngIf="filteredProduits.length === 0">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
        </svg>
        <p>Aucun produit fini trouvé.</p>
    </div>
</div>

<div class="modal-overlay delete-modal" *ngIf="showDeleteConfirm" (click)="cancelDelete()">
    <div class="modal-content small confirm-danger" (click)="$event.stopPropagation()">
        <div class="confirm-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path
                    d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />
            </svg>
        </div>
        <h3>Confirmer la suppression</h3>
        <p>Êtes-vous sûr de vouloir supprimer le produit <strong>{{ itemToDelete?.designation }}</strong> ?</p>
        <p class="warning-text">Cette action est irréversible.</p>

        <div class="modal-actions">
            <button class="btn-secondary" (click)="cancelDelete()">Annuler</button>
            <button class="btn-danger" (click)="deleteProduit(itemToDelete.id)">Supprimer</button>
        </div>
    </div>
</div>

<div class="modal-overlay produit-modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content produit-modal-content" (click)="$event.stopPropagation()">
        <div class="produit-modal-header">
            <div class="produit-modal-title-block">
                <div class="produit-modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                </div>
                <div>
                    <h2>{{ selectedProduit ? 'Modifier' : 'Ajouter' }} un produit</h2>
                    <p class="produit-modal-subtitle">{{ selectedProduit ? 'Mettre à jour les informations du produit' :
                        'Complétez les informations pour créer un nouveau produit fini' }}</p>
                </div>
            </div>
            <button class="btn-icon produit-modal-close" (click)="closeCreateModal()" type="button" title="Fermer">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <form #produitForm="ngForm" (ngSubmit)="produitForm.form.valid && saveProduit()" class="produit-modal-form">
            <div class="produit-form-scroll">
                <div class="form-section-row">
                    <div class="form-section image-section">
                        <label class="section-label">Image du produit</label>
                        <div class="image-preview-container" (click)="fileInput.click()">
                            <img *ngIf="imagePreview" [src]="getImageUrl(imagePreview)" class="preview-img">
                            <div class="overlay">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                    <circle cx="12" cy="13" r="4" />
                                </svg>
                                <span *ngIf="!imagePreview">Ajouter une image</span>
                            </div>
                        </div>
                        <input type="file" #fileInput (change)="onFileSelected($event)" hidden accept="image/*">
                    </div>

                    <div class="form-section flex-1">
                        <h3 class="form-section-title">Informations Générales</h3>

                        <div class="form-group produit-form-group">
                            <label>Code Produit <span class="required">*</span></label>
                            <div class="control-wrapper">
                                <input type="text" [(ngModel)]="newProduit.code" name="code" #c="ngModel" required
                                    placeholder="Ex: PROD-100">
                                <span class="error-msg" *ngIf="c.invalid && c.touched">Le code produit est
                                    obligatoire</span>
                            </div>
                        </div>

                        <div class="form-group produit-form-group">
                            <label>Désignation <span class="required">*</span></label>
                            <div class="control-wrapper">
                                <input type="text" [(ngModel)]="newProduit.designation" name="designation" #d="ngModel"
                                    required placeholder="Nom complet du produit">
                                <span class="error-msg" *ngIf="d.invalid && d.touched">La désignation est
                                    obligatoire</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="produit-modal-actions">
                <button type="button" class="btn-secondary" (click)="closeCreateModal()">Annuler</button>
                <button type="submit" class="btn-primary produit-btn-save" [disabled]="produitForm.invalid">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    {{ selectedProduit ? 'Mettre à jour' : 'Enregistrer' }}
                </button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" *ngIf="showAssociatedPiecesModal" (click)="closeAssociatedPiecesModal()">
    <div class="modal-content associated-modal" (click)="$event.stopPropagation()">
        <div class="associated-modal-header">
            <div class="associated-modal-title-block">
                <div class="associated-modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h2>Pièces Détachées Associées</h2>
                    <p class="associated-modal-subtitle" *ngIf="selectedProductForPieces">
                        Produit : {{ selectedProductForPieces.designation }} ({{ selectedProductForPieces.code }})
                    </p>
                </div>
            </div>
            <button class="btn-icon" (click)="closeAssociatedPiecesModal()" type="button" title="Fermer">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="associated-modal-body">
            <div class="associated-search">
                <input type="text" class="associated-search-input" [(ngModel)]="associatedPiecesSearchTerm"
                    (ngModelChange)="triggerChangeDetection()" placeholder="Rechercher une pièce associée...">
            </div>
            <div class="associated-grid">
                <div class="associated-card" *ngFor="let piece of filteredAssociatedPieces"
                    (click)="openPieceDetailsModal(piece)">
                    <div class="associated-card-image">
                        <img [src]="getImageUrl(piece.imageUrl)" [alt]="piece.designation"
                            onerror="this.onerror=null;this.src='assets/images/default-piece.svg'">
                    </div>
                    <div class="associated-card-info">
                        <code class="associated-card-code">{{ piece.reference }}</code>
                        <h4 class="associated-card-name">{{ piece.designation }}</h4>
                        <div class="associated-card-price">{{ piece.prixVente | currency:'TND' }}</div>
                    </div>
                </div>
            </div>
            <div class="associated-empty" *ngIf="selectedProductForPieces && filteredAssociatedPieces.length === 0">
                <p>Aucune pièce trouvée</p>
            </div>
        </div>
    </div>
</div>


<div class="modal-overlay" *ngIf="showPieceDetailsModal" (click)="closePieceDetailsModal()">
    <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
        <div class="detail-modal-header">
            <h2>Détails de la Pièce</h2>
            <button class="btn-icon" (click)="closePieceDetailsModal()" type="button" title="Fermer">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="detail-modal-body" *ngIf="selectedPieceForDetails">
            <div class="detail-image-section">
                <img [src]="getImageUrl(selectedPieceForDetails.imageUrl)" [alt]="selectedPieceForDetails.designation"
                    onerror="this.onerror=null;this.src='assets/images/default-piece.svg'">
            </div>
            <div class="detail-info-section">
                <h3>{{ selectedPieceForDetails.designation }}</h3>
                <div class="detail-row">
                    <span class="detail-label">Référence:</span>
                    <code class="detail-value">{{ selectedPieceForDetails.reference }}</code>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Code Barre:</span>
                    <code class="detail-value">{{ selectedPieceForDetails.codeBarre }}</code>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Prix de vente:</span>
                    <span class="detail-value">{{ selectedPieceForDetails.prixVente | currency:'TND' }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Seuil Minimum:</span>
                    <span class="detail-value">{{ selectedPieceForDetails.seuilMinimum }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">TVA:</span>
                    <span class="detail-value">{{ selectedPieceForDetails.tauxTVA }}%</span>
                </div>
            </div>
        </div>
    </div>
</div>